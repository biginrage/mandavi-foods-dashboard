<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandavi Foods - Business Dashboard</title>
    <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            --color-green-500: rgba(34, 197, 94, 1);
            --color-green-400: rgba(74, 222, 128, 1);

            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-green-500-rgb: 34, 197, 94;

            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-green-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

            --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-size-4xl: 30px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;

            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;

            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-gray-400-rgb: 119, 124, 124;
                --color-teal-300-rgb: 50, 184, 198;
                --color-gray-300-rgb: 167, 169, 169;
                --color-gray-200-rgb: 245, 245, 245;
                --color-green-400-rgb: 74, 222, 128;

                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
                --color-primary: var(--color-teal-300);
                --color-primary-hover: var(--color-teal-400);
                --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
                --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
                --color-border: rgba(var(--color-gray-400-rgb), 0.3);
                --color-error: var(--color-red-400);
                --color-success: var(--color-green-400);
                --color-btn-primary-text: var(--color-slate-900);
                --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.5;
            padding-bottom: 70px;
        }

        .header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-card-border);
            padding: var(--space-16) var(--space-20);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
        }

        .sync-status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-8);
            padding: var(--space-8) var(--space-12);
            background: rgba(var(--color-green-500-rgb), 0.15);
            border: 1px solid var(--color-success);
            border-radius: var(--radius-base);
            font-size: var(--font-size-xs);
            color: var(--color-success);
            font-weight: var(--font-weight-medium);
        }

        .sync-status-badge.syncing {
            background: rgba(230, 129, 97, 0.15);
            border-color: var(--color-orange-400);
            color: var(--color-orange-400);
        }

        .sync-status-badge.error {
            background: rgba(var(--color-red-500-rgb), 0.15);
            border-color: var(--color-error);
            color: var(--color-error);
        }

        .sync-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .theme-toggle {
            background: var(--color-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-8) var(--space-16);
            cursor: pointer;
            font-size: var(--font-size-sm);
            color: var(--color-text);
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--color-secondary-hover);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-20);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-24);
        }

        .stat-card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-20);
            box-shadow: var(--shadow-sm);
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-8);
        }

        .stat-value {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text);
        }

        .stat-currency {
            color: var(--color-primary);
        }

        .stat-positive {
            color: var(--color-success);
        }

        .stat-negative {
            color: var(--color-error);
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            margin-bottom: var(--space-20);
            box-shadow: var(--shadow-sm);
        }

        .card-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-20);
            color: var(--color-text);
        }

        .form-group {
            margin-bottom: var(--space-16);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-8);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-sm);
            color: var(--color-text);
        }

        .form-control {
            width: 100%;
            padding: var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            background: var(--color-background);
            color: var(--color-text);
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-focus-ring);
        }

        .btn {
            padding: var(--space-12) var(--space-24);
            border: none;
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-8);
            position: relative;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--color-secondary-hover);
        }

        .btn-full {
            width: 100%;
        }

        .chart-container {
            margin: var(--space-20) 0;
            padding: var(--space-16);
            background: var(--color-background);
            border-radius: var(--radius-base);
        }

        canvas {
            max-width: 100%;
            height: auto !important;
        }

        .table-container {
            overflow-x: auto;
            margin-top: var(--space-16);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        thead {
            background: var(--color-secondary);
        }

        th, td {
            padding: var(--space-12);
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        th {
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
        }

        tbody tr:hover {
            background: var(--color-secondary);
        }

        .filters {
            display: flex;
            gap: var(--space-12);
            margin-bottom: var(--space-20);
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--color-surface);
            border-top: 1px solid var(--color-card-border);
            display: flex;
            justify-content: space-around;
            padding: var(--space-8) 0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-8) var(--space-16);
            cursor: pointer;
            color: var(--color-text-secondary);
            font-size: var(--font-size-xs);
            transition: color 0.2s;
            border: none;
            background: none;
            flex: 1;
        }

        .nav-item.active {
            color: var(--color-primary);
        }

        .nav-item:hover {
            color: var(--color-primary);
        }

        .nav-icon {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--space-4);
        }

        .alert {
            padding: var(--space-16);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
            border-left: 4px solid;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: rgba(var(--color-green-500-rgb), 0.1);
            border-color: var(--color-success);
            color: var(--color-success);
        }

        .alert-error {
            background: rgba(var(--color-red-500-rgb), 0.1);
            border-color: var(--color-error);
            color: var(--color-error);
        }

        .alert-warning {
            background: rgba(230, 129, 97, 0.1);
            border-color: var(--color-orange-400);
            color: var(--color-orange-400);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-32);
            color: var(--color-text-secondary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: var(--space-16);
            opacity: 0.5;
        }

        .badge {
            display: inline-block;
            padding: var(--space-4) var(--space-8);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        .badge-success {
            background: rgba(var(--color-green-500-rgb), 0.15);
            color: var(--color-success);
        }

        .badge-error {
            background: rgba(var(--color-red-500-rgb), 0.15);
            color: var(--color-error);
        }

        .delete-btn {
            background: transparent;
            border: none;
            color: var(--color-error);
            cursor: pointer;
            padding: var(--space-4);
            font-size: var(--font-size-lg);
        }

        .delete-btn:hover {
            opacity: 0.7;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--space-12);
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
            }

            .filter-group {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">üçΩÔ∏è Mandavi Foods</div>
            <div style="display: flex; gap: var(--space-12); align-items: center;">
                <div class="sync-status-badge" id="syncStatus">
                    <div class="sync-dot"></div>
                    <span>Connected</span>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()">üåì Theme</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Home Page -->
        <div id="home" class="page active">
            <h2 class="card-title">Today's Summary</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Today's Sales</div>
                    <div class="stat-value stat-currency">‚Çπ<span id="todaySales">0.00</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Today's Purchase</div>
                    <div class="stat-value stat-currency">‚Çπ<span id="todayPurchase">0.00</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Today's Profit</div>
                    <div class="stat-value stat-positive" id="todayProfitValue">‚Çπ<span id="todayProfit">0.00</span></div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">This Month Overview</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Monthly Sales</div>
                        <div class="stat-value stat-currency">‚Çπ<span id="monthlySales">0.00</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Monthly Purchase</div>
                        <div class="stat-value stat-currency">‚Çπ<span id="monthlyPurchase">0.00</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Monthly Profit</div>
                        <div class="stat-value stat-positive" id="monthlyProfitValue">‚Çπ<span id="monthlyProfit">0.00</span></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Recent Entries</h3>
                <div id="recentEntriesContainer"><div class="empty-state"><div class="empty-icon">üì≠</div><p>No entries yet. Add your first entry!</p></div></div>
            </div>
        </div>

        <!-- Daily Entry Page -->
        <div id="entry" class="page">
            <div class="card">
                <h2 class="card-title">Add Daily Entry</h2>
                <div id="entryAlert"></div>
                <form id="entryForm">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="entryDate" required="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Product Name</label>
                        <input type="text" class="form-control" id="productName" placeholder="e.g., Rice, Wheat Flour" required="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-control" id="category" required="">
                            <option value="">Select Category</option>
                            <option value="Grains">Grains</option>
                            <option value="Pulses">Pulses</option>
                            <option value="Spices">Spices</option>
                            <option value="Oil">Oil</option>
                            <option value="Snacks">Snacks</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantity (kg)</label>
                        <input type="number" class="form-control" id="quantity" step="0.01" placeholder="0.00" required="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Purchase Price (‚Çπ per kg)</label>
                        <input type="number" class="form-control" id="purchasePrice" step="0.01" placeholder="0.00" required="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Selling Price (‚Çπ per kg)</label>
                        <input type="number" class="form-control" id="sellingPrice" step="0.01" placeholder="0.00" required="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Remarks (Optional)</label>
                        <textarea class="form-control" id="remarks" rows="3" placeholder="Any additional notes..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full" id="submitBtn">‚ûï Add Entry & Sync</button>
                </form>
            </div>
        </div>

        <!-- Monthly Trends Page -->
        <div id="trends" class="page">
            <h2 class="card-title">Monthly Trends</h2>

            <div class="card">
                <h3 class="card-title">Sales vs Purchase Comparison</h3>
                <div class="chart-container">
                    <canvas id="monthlyComparisonChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Profit Growth Trend</h3>
                <div class="chart-container">
                    <canvas id="profitTrendChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Monthly Summary Table</h3>
                <div class="table-container">
                    <table id="monthlySummaryTable">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Total Sales (‚Çπ)</th>
                                <th>Total Purchase (‚Çπ)</th>
                                <th>Profit/Loss (‚Çπ)</th>
                                <th>Margin (%)</th>
                            </tr>
                        </thead>
                        <tbody id="monthlySummaryBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div id="analytics" class="page">
            <h2 class="card-title">Analytics & Reports</h2>

            <div class="filters">
                <div class="filter-group">
                    <label class="form-label">From Date</label>
                    <input type="date" class="form-control" id="filterFromDate">
                </div>
                <div class="filter-group">
                    <label class="form-label">To Date</label>
                    <input type="date" class="form-control" id="filterToDate">
                </div>
                <div class="filter-group">
                    <label class="form-label">Category</label>
                    <select class="form-control" id="filterCategory">
                        <option value="">All Categories</option>
                        <option value="Grains">Grains</option>
                        <option value="Pulses">Pulses</option>
                        <option value="Spices">Spices</option>
                        <option value="Oil">Oil</option>
                        <option value="Snacks">Snacks</option>
                        <option value="Others">Others</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Top 5 Selling Products</h3>
                <div class="chart-container">
                    <canvas id="topProductsChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Highest Margin Products</h3>
                <div class="chart-container">
                    <canvas id="marginChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Daily Sales Trend</h3>
                <div class="chart-container">
                    <canvas id="dailySalesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="admin" class="page">
            <h2 class="card-title">Admin Panel</h2>

            <div class="card">
                <h3 class="card-title">All Entries</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Qty (kg)</th>
                                <th>Purchase (‚Çπ)</th>
                                <th>Selling (‚Çπ)</th>
                                <th>Profit (‚Çπ)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="adminEntriesTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Export Data</h3>
                <p style="margin-bottom: 16px; color: var(--color-text-secondary);">Download your business data for backup or analysis</p>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="exportToCSV()">üì• Export to CSV</button>
                    <button class="btn btn-secondary" onclick="importFromCSV()">üì§ Import from CSV</button>
                </div>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="showPage('home')">
            <div class="nav-icon">üè†</div>
            <div>Home</div>
        </button>
        <button class="nav-item" onclick="showPage('entry')">
            <div class="nav-icon">‚ûï</div>
            <div>Entry</div>
        </button>
        <button class="nav-item" onclick="showPage('trends')">
            <div class="nav-icon">üìä</div>
            <div>Trends</div>
        </button>
        <button class="nav-item" onclick="showPage('analytics')">
            <div class="nav-icon">üìà</div>
            <div>Analytics</div>
        </button>
        <button class="nav-item" onclick="showPage('admin')">
            <div class="nav-icon">‚öôÔ∏è</div>
            <div>Admin</div>
        </button>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const API_URL = 'https://mandavi-foods-dashboard.vercel.app/api/sheets';
        let entries = [];
        let charts = {};

        function loadData() {
            const stored = localStorage.getItem('mandaviFoodsData');
            if (stored) {
                entries = JSON.parse(stored);
            }
        }

        function saveData() {
            localStorage.setItem('mandaviFoodsData', JSON.stringify(entries));
        }

        function updateSyncStatus(status, text) {
            const badge = document.getElementById('syncStatus');
            badge.className = 'sync-status-badge';
            if (status === 'syncing') badge.classList.add('syncing');
            if (status === 'error') badge.classList.add('error');
            badge.querySelector('span').textContent = text;
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            document.getElementById(pageId).classList.add('active');
            event.currentTarget.classList.add('active');

            if (pageId === 'home') updateHome();
            if (pageId === 'trends') updateTrends();
            if (pageId === 'analytics') updateAnalytics();
            if (pageId === 'admin') updateAdmin();
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentScheme = html.getAttribute('data-color-scheme');
            html.setAttribute('data-color-scheme', currentScheme === 'dark' ? 'light' : 'dark');
        }

        document.getElementById('entryForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Syncing...';

            updateSyncStatus('syncing', 'Syncing...');

            const entry = {
                id: Date.now(),
                date: document.getElementById('entryDate').value,
                product: document.getElementById('productName').value,
                category: document.getElementById('category').value,
                quantity: parseFloat(document.getElementById('quantity').value),
                purchasePrice: parseFloat(document.getElementById('purchasePrice').value),
                sellingPrice: parseFloat(document.getElementById('sellingPrice').value),
                remarks: document.getElementById('remarks').value,
                totalPurchase: 0,
                totalSale: 0,
                profit: 0
            };

            entry.totalPurchase = entry.quantity * entry.purchasePrice;
            entry.totalSale = entry.quantity * entry.sellingPrice;
            entry.profit = entry.totalSale - entry.totalPurchase;

            try {
                // Try to sync to Google Sheet via backend
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'addEntry', data: entry })
                });

                const result = await response.json();

                if (result.success) {
                    // Save locally
                    entries.push(entry);
                    saveData();

                    const alertDiv = document.getElementById('entryAlert');
                    alertDiv.innerHTML = '<div class="alert alert-success">‚úì Entry synced to Google Sheet successfully!</div>';

                    updateSyncStatus('connected', 'Connected');
                } else {
                    throw new Error('Sync failed');
                }
            } catch (error) {
                console.error('Sync error:', error);

                // Fall back to local storage
                entries.push(entry);
                saveData();

                const alertDiv = document.getElementById('entryAlert');
                alertDiv.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Saved locally. Sync will retry when connection is available.</div>';

                updateSyncStatus('error', 'Sync failed');

                // Retry after 5 seconds
                setTimeout(() => updateSyncStatus('connected', 'Connected'), 5000);
            }

            document.getElementById('entryForm').reset();
            document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            submitBtn.disabled = false;
            submitBtn.innerHTML = '‚ûï Add Entry & Sync';

            setTimeout(() => {
                document.getElementById('entryAlert').innerHTML = '';
            }, 4000);

            updateHome();
        });

        function updateHome() {
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const todayEntries = entries.filter(e => e.date === today);
            const monthEntries = entries.filter(e => {
                const d = new Date(e.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });

            const todaySales = todayEntries.reduce((sum, e) => sum + e.totalSale, 0);
            const todayPurchase = todayEntries.reduce((sum, e) => sum + e.totalPurchase, 0);
            const todayProfit = todaySales - todayPurchase;

            const monthlySales = monthEntries.reduce((sum, e) => sum + e.totalSale, 0);
            const monthlyPurchase = monthEntries.reduce((sum, e) => sum + e.totalPurchase, 0);
            const monthlyProfit = monthlySales - monthlyPurchase;

            document.getElementById('todaySales').textContent = todaySales.toFixed(2);
            document.getElementById('todayPurchase').textContent = todayPurchase.toFixed(2);
            document.getElementById('todayProfit').textContent = todayProfit.toFixed(2);
            document.getElementById('todayProfitValue').className = 'stat-value ' + (todayProfit >= 0 ? 'stat-positive' : 'stat-negative');

            document.getElementById('monthlySales').textContent = monthlySales.toFixed(2);
            document.getElementById('monthlyPurchase').textContent = monthlyPurchase.toFixed(2);
            document.getElementById('monthlyProfit').textContent = monthlyProfit.toFixed(2);
            document.getElementById('monthlyProfitValue').className = 'stat-value ' + (monthlyProfit >= 0 ? 'stat-positive' : 'stat-negative');

            const recent = entries.slice(-5).reverse();
            const recentHTML = recent.length > 0 ? `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Product</th>
                                <th>Qty</th>
                                <th>Profit</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recent.map(e => `
                                <tr>
                                    <td>${new Date(e.date).toLocaleDateString('en-IN')}</td>
                                    <td>${e.product}</td>
                                    <td>${e.quantity} kg</td>
                                    <td><span class="badge ${e.profit >= 0 ? 'badge-success' : 'badge-error'}">‚Çπ${e.profit.toFixed(2)}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : '<div class="empty-state"><div class="empty-icon">üì≠</div><p>No entries yet. Add your first entry!</p></div>';

            document.getElementById('recentEntriesContainer').innerHTML = recentHTML;
        }

        function updateTrends() {
            const monthlyData = getMonthlyData();

            if (charts.monthlyComparison) charts.monthlyComparison.destroy();
            if (charts.profitTrend) charts.profitTrend.destroy();

            const ctx1 = document.getElementById('monthlyComparisonChart').getContext('2d');
            charts.monthlyComparison = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: monthlyData.labels,
                    datasets: [{
                        label: 'Sales (‚Çπ)',
                        data: monthlyData.sales,
                        backgroundColor: 'rgba(33, 128, 141, 0.7)',
                        borderColor: 'rgba(33, 128, 141, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Purchase (‚Çπ)',
                        data: monthlyData.purchases,
                        backgroundColor: 'rgba(230, 129, 97, 0.7)',
                        borderColor: 'rgba(230, 129, 97, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            const ctx2 = document.getElementById('profitTrendChart').getContext('2d');
            charts.profitTrend = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: monthlyData.labels,
                    datasets: [{
                        label: 'Profit (‚Çπ)',
                        data: monthlyData.profits,
                        borderColor: 'rgba(34, 197, 94, 1)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            const tableBody = document.getElementById('monthlySummaryBody');
            tableBody.innerHTML = monthlyData.labels.map((month, i) => {
                const sales = monthlyData.sales[i];
                const purchase = monthlyData.purchases[i];
                const profit = monthlyData.profits[i];
                const margin = sales > 0 ? ((profit / sales) * 100).toFixed(2) : 0;
                return `
                    <tr>
                        <td>${month}</td>
                        <td>‚Çπ${sales.toFixed(2)}</td>
                        <td>‚Çπ${purchase.toFixed(2)}</td>
                        <td><span class="badge ${profit >= 0 ? 'badge-success' : 'badge-error'}">‚Çπ${profit.toFixed(2)}</span></td>
                        <td>${margin}%</td>
                    </tr>
                `;
            }).join('');
        }

        function getMonthlyData() {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentYear = new Date().getFullYear();

            const data = months.map((month, i) => {
                const monthEntries = entries.filter(e => {
                    const d = new Date(e.date);
                    return d.getMonth() === i && d.getFullYear() === currentYear;
                });

                return {
                    month: month,
                    sales: monthEntries.reduce((sum, e) => sum + e.totalSale, 0),
                    purchases: monthEntries.reduce((sum, e) => sum + e.totalPurchase, 0)
                };
            });

            return {
                labels: data.map(d => d.month),
                sales: data.map(d => d.sales),
                purchases: data.map(d => d.purchases),
                profits: data.map(d => d.sales - d.purchases)
            };
        }

        function updateAnalytics() {
            const filteredEntries = getFilteredEntries();

            const productSales = {};
            filteredEntries.forEach(e => {
                if (!productSales[e.product]) {
                    productSales[e.product] = { sales: 0, profit: 0, margin: 0 };
                }
                productSales[e.product].sales += e.totalSale;
                productSales[e.product].profit += e.profit;
            });

            Object.keys(productSales).forEach(product => {
                const data = productSales[product];
                data.margin = data.sales > 0 ? (data.profit / data.sales) * 100 : 0;
            });

            const topProducts = Object.entries(productSales)
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 5);

            const topMargins = Object.entries(productSales)
                .sort((a, b) => b[1].margin - a[1].margin)
                .slice(0, 5);

            if (charts.topProducts) charts.topProducts.destroy();
            if (charts.margins) charts.margins.destroy();
            if (charts.dailySales) charts.dailySales.destroy();

            const ctx3 = document.getElementById('topProductsChart').getContext('2d');
            charts.topProducts = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: topProducts.map(p => p[0]),
                    datasets: [{
                        label: 'Sales (‚Çπ)',
                        data: topProducts.map(p => p[1].sales),
                        backgroundColor: 'rgba(33, 128, 141, 0.7)',
                        borderColor: 'rgba(33, 128, 141, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: { x: { beginAtZero: true } }
                }
            });

            const ctx4 = document.getElementById('marginChart').getContext('2d');
            charts.margins = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: topMargins.map(p => p[0]),
                    datasets: [{
                        label: 'Margin (%)',
                        data: topMargins.map(p => p[1].margin),
                        backgroundColor: 'rgba(34, 197, 94, 0.7)',
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: { x: { beginAtZero: true } }
                }
            });

            const dailyData = getDailySalesData(filteredEntries);
            const ctx5 = document.getElementById('dailySalesChart').getContext('2d');
            charts.dailySales = new Chart(ctx5, {
                type: 'line',
                data: {
                    labels: dailyData.labels,
                    datasets: [{
                        label: 'Daily Sales (‚Çπ)',
                        data: dailyData.sales,
                        borderColor: 'rgba(33, 128, 141, 1)',
                        backgroundColor: 'rgba(33, 128, 141, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function getDailySalesData(filteredEntries) {
            const dailySales = {};
            filteredEntries.forEach(e => {
                const date = new Date(e.date).toLocaleDateString('en-IN');
                dailySales[date] = (dailySales[date] || 0) + e.totalSale;
            });

            const sorted = Object.entries(dailySales).sort((a, b) => new Date(a[0]) - new Date(b[0]));

            return {
                labels: sorted.map(d => d[0]),
                sales: sorted.map(d => d[1])
            };
        }

        function getFilteredEntries() {
            let filtered = [...entries];

            const fromDate = document.getElementById('filterFromDate').value;
            const toDate = document.getElementById('filterToDate').value;
            const category = document.getElementById('filterCategory').value;

            if (fromDate) {
                filtered = filtered.filter(e => e.date >= fromDate);
            }
            if (toDate) {
                filtered = filtered.filter(e => e.date <= toDate);
            }
            if (category) {
                filtered = filtered.filter(e => e.category === category);
            }

            return filtered;
        }

        document.getElementById('filterFromDate').addEventListener('change', updateAnalytics);
        document.getElementById('filterToDate').addEventListener('change', updateAnalytics);
        document.getElementById('filterCategory').addEventListener('change', updateAnalytics);

        function updateAdmin() {
            const tableBody = document.getElementById('adminEntriesTable');

            if (entries.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 32px; color: var(--color-text-secondary);">No entries yet</td></tr>';
                return;
            }

            tableBody.innerHTML = entries.map(e => `
                <tr>
                    <td>${new Date(e.date).toLocaleDateString('en-IN')}</td>
                    <td>${e.product}</td>
                    <td>${e.category}</td>
                    <td>${e.quantity}</td>
                    <td>‚Çπ${e.purchasePrice.toFixed(2)}</td>
                    <td>‚Çπ${e.sellingPrice.toFixed(2)}</td>
                    <td><span class="badge ${e.profit >= 0 ? 'badge-success' : 'badge-error'}">‚Çπ${e.profit.toFixed(2)}</span></td>
                    <td><button class="delete-btn" onclick="deleteEntry(${e.id})">üóëÔ∏è</button></td>
                </tr>
            `).join('');
        }

        function deleteEntry(id) {
            if (confirm('Are you sure you want to delete this entry?')) {
                entries = entries.filter(e => e.id !== id);
                saveData();
                updateAdmin();
                updateHome();
            }
        }

        function exportToCSV() {
            if (entries.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['Date', 'Product', 'Category', 'Quantity (kg)', 'Purchase Price', 'Selling Price', 'Total Purchase', 'Total Sale', 'Profit', 'Remarks'];
            const rows = entries.map(e => [
                e.date,
                e.product,
                e.category,
                e.quantity,
                e.purchasePrice,
                e.sellingPrice,
                e.totalPurchase,
                e.totalSale,
                e.profit,
                e.remarks
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mandavi_foods_data_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function importFromCSV() {
            document.getElementById('csvFileInput').click();
        }

        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                const newEntries = [];

                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;

                    const values = lines[i].match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g).map(v => v.replace(/^"|"$/g, ''));

                    if (values.length >= 9) {
                        newEntries.push({
                            id: Date.now() + i,
                            date: values[0],
                            product: values[1],
                            category: values[2],
                            quantity: parseFloat(values[3]),
                            purchasePrice: parseFloat(values[4]),
                            sellingPrice: parseFloat(values[5]),
                            totalPurchase: parseFloat(values[6]),
                            totalSale: parseFloat(values[7]),
                            profit: parseFloat(values[8]),
                            remarks: values[9] || ''
                        });
                    }
                }

                if (confirm(`Import ${newEntries.length} entries? This will add to existing data.`)) {
                    entries = entries.concat(newEntries);
                    saveData();
                    updateAdmin();
                    updateHome();
                    alert('Data imported successfully!');
                }
            };
            reader.readAsText(file);
        }

        document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
        loadData();
        updateHome();
    </script>

</body></html>
